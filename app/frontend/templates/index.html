<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Football Live Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .match-card {
            transition: transform 0.2s ease-in-out;
        }
        .match-card:hover {
            transform: translateY(-2px);
        }
        .bio-rhythm-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="league-title" class="text-3xl font-bold">Serie A 2025/2026</h1>
                    <p id="league-subtitle" class="text-blue-200">Previsioni Live e Analisi in Tempo Reale</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-blue-200">Ultimo aggiornamento: <span id="last-updated">--:--</span></div>
                    <div class="text-xs text-blue-300">Dati aggiornati ogni 5 minuti</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Buttons -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-wrap justify-start mb-3 space-x-2 space-y-2">
                <button id="league-seriea-btn" onclick="setLeague('seriea')" class="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm">
                    Serie A
                </button>
                <button id="league-norway-btn" onclick="setLeague('norway')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">
                    Eliteserien Norvegia
                </button>
                <button id="league-premier-btn" onclick="setLeague('premier')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">
                    Premier League
                </button>
                <button id="league-bundesliga-btn" onclick="setLeague('bundesliga')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">
                    Bundesliga
                </button>
                <button id="league-laliga-btn" onclick="setLeague('laliga')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">
                    La Liga
                </button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-9 gap-2">
                <button onclick="showSection('live-matches')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üìä Live
                </button>
                <button onclick="showSection('standings')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üèÜ Classifica
                </button>
                <button onclick="showSection('scorers')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‚öΩ Marcatori
                </button>
                <button onclick="showSection('predictions')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üîÆ Previsioni gare
                </button>
                <button onclick="showSection('cards')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üü® Cartellini
                </button>
                <button onclick="showSection('finished')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‚úÖ Concluse
                </button>
                <button onclick="showSection('analysis')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üìà Analisi
                </button>
                <button onclick="showSection('top-picks')" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‚≠ê Top gare
                </button>
                <button onclick="showSection('playable')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg transition-colors">
                    üéØ Gare da giocare
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Live Matches Section -->
        <section id="live-matches" class="section">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">üéØ Partite in Corso - Live</h2>
            <div id="live-matches-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Match cards will be loaded here -->
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento partite in corso...</p>
                </div>
            </div>
        </section>

        <!-- Standings Section -->
        <section id="standings" class="section hidden">
            <h2 id="standings-title" class="text-2xl font-bold mb-6 text-gray-800">üèÜ Classifica Serie A</h2>
            <div id="standings-container">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento classifica...</p>
                </div>
            </div>
        </section>

        <!-- Top Scorers Section -->
        <section id="scorers" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">‚öΩ Top Marcatori</h2>
            <div id="scorers-container">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento marcatori...</p>
                </div>
            </div>
        </section>

        <!-- Cards Section -->
        <section id="cards" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">üü® Statistiche Cartellini</h2>
            <div id="cards-container">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento statistiche cartellini...</p>
                </div>
            </div>
        </section>

        <!-- Predictions Section -->
        <section id="predictions" class="section hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üîÆ Previsioni Prossima Giornata</h2>
                <div class="mt-3 md:mt-0 flex items-center space-x-3">
                    <label class="inline-flex items-center space-x-2 text-sm text-gray-700 cursor-pointer">
                        <input id="only-top-picks-toggle" type="checkbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                        <span>Mostra solo pronostici ad alta affidabilit√†</span>
                    </label>
                </div>
            </div>
            <div id="predictions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento previsioni gare...</p>
                </div>
            </div>
        </section>

        <!-- Top Picks Section -->
        <section id="top-picks" class="section hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">‚≠ê Migliori top gare per giornata</h2>
                <div class="mt-3 md:mt-0 flex items-center space-x-3">
                    <div>
                        <label for="top-picks-matchday" class="block text-sm font-medium text-gray-700">Giornata</label>
                        <input id="top-picks-matchday" type="number" min="1" class="mt-1 block w-24 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ultima">
                    </div>
                    <button onclick="loadSectionData('top-picks')" class="mt-5 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-pink-500 hover:bg-pink-600">
                        Aggiorna
                    </button>
                </div>
            </div>
            <div id="top-picks-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare...</p>
                </div>
            </div>
        </section>

        <!-- Playable Matches Section -->
        <section id="playable" class="section hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üéØ Gare da giocare</h2>
                <p class="mt-3 md:mt-0 text-sm text-gray-600 max-w-xl">
                    Selezione delle migliori tre partite da giocare per ogni campionato,
                    basata sulle probabilit√† pi√π alte del modello e sulla sua affidabilit√† recente.
                </p>
            </div>
            <div id="playable-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento gare da giocare...</p>
                </div>
            </div>
        </section>

        <!-- Finished Matches Section -->
        <section id="finished" class="section hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">‚úÖ Partite Concluse</h2>
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <div>
                    <label for="finished-matchday" class="block text-sm font-medium text-gray-700">Giornata</label>
                    <input id="finished-matchday" type="number" min="1" class="mt-1 block w-24 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Tutte">
                </div>
                <button onclick="loadSectionData('finished')" class="mt-5 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                    Aggiorna
                </button>
                <button onclick="document.getElementById('finished-matchday').value='';loadSectionData('finished')" class="mt-5 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                    Tutta la stagione
                </button>
            </div>
            <div id="finished-matches-container">
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento partite concluse...</p>
                </div>
            </div>
        </section>

        <!-- Analysis Section -->
        <section id="analysis" class="section hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">üìà Analisi Giornaliera</h2>
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <div>
                    <label for="analysis-date" class="block text-sm font-medium text-gray-700">Data</label>
                    <input id="analysis-date" type="date" class="mt-1 block border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button onclick="loadSectionData('analysis')" class="mt-5 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                    Aggiorna
                </button>
                <button onclick="document.getElementById('analysis-date').value='';loadSectionData('analysis')" class="mt-5 inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50">
                    Oggi
                </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="space-y-4 lg:col-span-1">
                    <div id="model-quality-container">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-semibold text-gray-700 mb-2">üéØ Qualit√† Modello</h3>
                            <div class="text-sm text-gray-600">
                                <p class="mb-1">Caricamento qualit√† modello...</p>
                            </div>
                        </div>
                    </div>
                    <div id="history-2025-container">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-semibold text-gray-700 mb-2">üìÖ Storico 2025</h3>
                            <div class="text-sm text-gray-600">
                                <p class="mb-1">Caricamento storico agosto-dicembre 2025...</p>
                            </div>
                        </div>
                    </div>
                    <div id="history-progress-container">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-semibold text-gray-700 mb-2">üìä Confronto 2025 vs 2026</h3>
                            <div class="text-sm text-gray-600">
                                <p class="mb-1">Caricamento andamento stagione 2026...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="analysis-container" class="lg:col-span-3">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="text-gray-600 mt-4">Caricamento analisi...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>¬© 2025 Global Football Live Analytics - Sistema di analisi in tempo reale</p>
            <p class="text-sm text-gray-400 mt-2">Dati aggiornati da multiple fonti ufficiali</p>
        </div>
    </footer>

    <script>
        // API configuration
        const API_BASE_URL = `${window.location.origin}/api/v1`;
        const API_KEY = 'test-api-key-12345';

        // Current state
        let currentSection = 'live-matches';
        let currentLeague = 'seriea';
        let autoRefreshInterval;
        let history2025Stats = null;

        // Show specific section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');
            currentSection = sectionId;
            
            // Load data for the section
            loadSectionData(sectionId);
        }

        function setLeague(league) {
            currentLeague = league;
            const titleEl = document.getElementById('league-title');
            const subtitleEl = document.getElementById('league-subtitle');
            const standingsTitleEl = document.getElementById('standings-title');
            const serieABtn = document.getElementById('league-seriea-btn');
            const norwayBtn = document.getElementById('league-norway-btn');
            const premierBtn = document.getElementById('league-premier-btn');
            const bundesligaBtn = document.getElementById('league-bundesliga-btn');
            const laligaBtn = document.getElementById('league-laliga-btn');

            function resetButton(btn) {
                if (!btn) return;
                btn.classList.add('bg-gray-200', 'text-gray-700');
                btn.classList.remove('bg-blue-900', 'text-white');
            }

            function activateButton(btn) {
                if (!btn) return;
                btn.classList.add('bg-blue-900', 'text-white');
                btn.classList.remove('bg-gray-200', 'text-gray-700');
            }

            resetButton(serieABtn);
            resetButton(norwayBtn);
            resetButton(premierBtn);
            resetButton(bundesligaBtn);
            resetButton(laligaBtn);

            if (league === 'seriea') {
                if (titleEl) titleEl.textContent = 'Serie A 2025/2026';
                if (subtitleEl) subtitleEl.textContent = 'Previsioni Live e Analisi in Tempo Reale';
                if (standingsTitleEl) standingsTitleEl.textContent = 'üèÜ Classifica Serie A';
                activateButton(serieABtn);
            } else if (league === 'norway') {
                if (titleEl) titleEl.textContent = 'Eliteserien Norvegese';
                if (subtitleEl) subtitleEl.textContent = 'Dati live e classifica del campionato norvegese';
                if (standingsTitleEl) standingsTitleEl.textContent = 'üèÜ Classifica Eliteserien';
                activateButton(norwayBtn);
            } else if (league === 'premier') {
                if (titleEl) titleEl.textContent = 'Premier League';
                if (subtitleEl) subtitleEl.textContent = 'Dati live, classifica e previsioni Premier League';
                if (standingsTitleEl) standingsTitleEl.textContent = 'üèÜ Classifica Premier League';
                activateButton(premierBtn);
            } else if (league === 'bundesliga') {
                if (titleEl) titleEl.textContent = 'Bundesliga';
                if (subtitleEl) subtitleEl.textContent = 'Dati live, classifica e previsioni Bundesliga';
                if (standingsTitleEl) standingsTitleEl.textContent = 'üèÜ Classifica Bundesliga';
                activateButton(bundesligaBtn);
            } else if (league === 'laliga') {
                if (titleEl) titleEl.textContent = 'La Liga';
                if (subtitleEl) subtitleEl.textContent = 'Dati live, classifica e previsioni La Liga';
                if (standingsTitleEl) standingsTitleEl.textContent = 'üèÜ Classifica La Liga';
                activateButton(laligaBtn);
            }

            loadSectionData(currentSection);
        }

        async function loadSectionData(sectionId) {
            try {
                switch(sectionId) {
                    case 'live-matches':
                        if (currentLeague === 'seriea') {
                            await loadLiveMatches();
                        } else if (currentLeague === 'norway') {
                            await loadLiveMatchesNorway();
                        } else if (currentLeague === 'premier') {
                            await loadLiveMatchesPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadLiveMatchesBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadLiveMatchesLaLiga();
                        }
                        break;
                    case 'standings':
                        if (currentLeague === 'seriea') {
                            await loadStandings();
                        } else if (currentLeague === 'norway') {
                            await loadStandingsNorway();
                        } else if (currentLeague === 'premier') {
                            await loadStandingsPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadStandingsBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadStandingsLaLiga();
                        }
                        break;
                    case 'scorers':
                        if (currentLeague === 'seriea') {
                            await loadTopScorers();
                        } else if (currentLeague === 'norway') {
                            await loadTopScorersNorway();
                        } else if (currentLeague === 'premier') {
                            await loadTopScorersPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadTopScorersBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadTopScorersLaLiga();
                        }
                        break;
                    case 'cards':
                        if (currentLeague === 'seriea') {
                            await loadCardsStats();
                        } else if (currentLeague === 'norway') {
                            await loadCardsStatsNorway();
                        } else if (currentLeague === 'premier') {
                            await loadCardsStatsPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadCardsStatsBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadCardsStatsLaLiga();
                        }
                        break;
                    case 'predictions':
                        if (currentLeague === 'seriea') {
                            await loadPredictions();
                        } else if (currentLeague === 'norway') {
                            await loadPredictionsNorway();
                        } else if (currentLeague === 'premier') {
                            await loadPredictionsPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadPredictionsBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadPredictionsLaLiga();
                        }
                        break;
                    case 'finished':
                        if (currentLeague === 'seriea') {
                            await loadFinishedMatches();
                        } else if (currentLeague === 'norway') {
                            await loadFinishedMatchesNorway();
                        } else if (currentLeague === 'premier') {
                            await loadFinishedMatchesPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadFinishedMatchesBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadFinishedMatchesLaLiga();
                        }
                        break;
                    case 'analysis':
                        if (currentLeague === 'seriea') {
                            await Promise.all([
                                loadModelQuality('seriea'),
                                loadDailyAnalysis(),
                                loadHistory2025Stats(),
                                loadHistoryProgressStats()
                            ]);
                        } else if (currentLeague === 'norway') {
                            await Promise.all([
                                loadModelQuality('norway'),
                                loadDailyAnalysisNorway(),
                                loadHistory2025Stats(),
                                loadHistoryProgressStats()
                            ]);
                        } else if (currentLeague === 'premier') {
                            await Promise.all([
                                loadModelQuality('premier'),
                                loadDailyAnalysisPremier(),
                                loadHistory2025Stats(),
                                loadHistoryProgressStats()
                            ]);
                        } else if (currentLeague === 'bundesliga') {
                            await Promise.all([
                                loadModelQuality('bundesliga'),
                                loadDailyAnalysisBundesliga(),
                                loadHistory2025Stats(),
                                loadHistoryProgressStats()
                            ]);
                        } else if (currentLeague === 'laliga') {
                            await Promise.all([
                                loadModelQuality('laliga'),
                                loadDailyAnalysisLaLiga(),
                                loadHistory2025Stats(),
                                loadHistoryProgressStats()
                            ]);
                        }
                        break;
                    case 'top-picks':
                        if (currentLeague === 'seriea') {
                            await loadTopPicks();
                        } else if (currentLeague === 'norway') {
                            await loadTopPicksNorway();
                        } else if (currentLeague === 'premier') {
                            await loadTopPicksPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadTopPicksBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadTopPicksLaLiga();
                        }
                        break;
                    case 'playable':
                        if (currentLeague === 'seriea') {
                            await loadPlayableMatches();
                        } else if (currentLeague === 'norway') {
                            await loadPlayableMatchesNorway();
                        } else if (currentLeague === 'premier') {
                            await loadPlayableMatchesPremier();
                        } else if (currentLeague === 'bundesliga') {
                            await loadPlayableMatchesBundesliga();
                        } else if (currentLeague === 'laliga') {
                            await loadPlayableMatchesLaLiga();
                        }
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
                showError(sectionId, 'Errore nel caricamento dei dati');
            }
        }

        async function loadTopPicks() {
            const container = document.getElementById('top-picks-container');
            if (!container) return;

            const matchdayInput = document.getElementById('top-picks-matchday');
            const matchdayValue = matchdayInput && matchdayInput.value ? matchdayInput.value : null;

            let url = `${API_BASE_URL}/predictions/evaluate/seriea`;
            if (matchdayValue) {
                url += `?matchday=${encodeURIComponent(matchdayValue)}`;
            }

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare...</p>
                </div>
            `;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !Array.isArray(data.matches) || data.matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara valutata per questa giornata</h3>
                            <p class="text-gray-600">Seleziona un'altra giornata o attendi che siano disponibili nuove valutazioni.</p>
                        </div>
                    `;
                    return;
                }

                const sorted = data.matches.slice().sort((a, b) => {
                    const accA = typeof a.prediction_success_probability === 'number' ? a.prediction_success_probability : 0;
                    const accB = typeof b.prediction_success_probability === 'number' ? b.prediction_success_probability : 0;
                    return accB - accA;
                });

                const minSuccessThreshold = 70;
                const maxTopMatches = 6;

                const topMatches = sorted.filter(m => {
                    const acc = typeof m.prediction_success_probability === 'number' ? m.prediction_success_probability : 0;
                    return acc >= minSuccessThreshold;
                }).slice(0, maxTopMatches);

                if (topMatches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara con alta probabilit√† di successo</h3>
                            <p class="text-gray-600">Per questa giornata il modello non ha individuato pronostici davvero affidabili.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (typeof data.overall_accuracy === 'number') {
                    const overallPct = Math.round(data.overall_accuracy * 100);
                    const leagueStats = history2025Stats
                        ? (history2025Stats.seriea || history2025Stats.overall)
                        : null;
                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 Serie A: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† pronostici giornata</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">${overallPct}% successo complessivo</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Basata su ${data.matches_evaluated || data.matches.length} partite valutate
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">
                                        Selezione delle gare con maggiore probabilit√† storica di pronostico corretto
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const item of topMatches) {
                    const homeTeam = item.home_team || (item.match && item.match.home_team) || 'Casa';
                    const awayTeam = item.away_team || (item.match && item.match.away_team) || 'Trasferta';
                    const matchday = item.matchday || (item.match && item.match.matchday) || data.matchday || '-';

                    const successProb = typeof item.prediction_success_probability === 'number'
                        ? Math.round(item.prediction_success_probability)
                        : null;

                    const modelProb = typeof item.predicted_outcome_probability === 'number'
                        ? Math.round(item.predicted_outcome_probability)
                        : null;

                    const outcomeLabel = item.predicted_outcome || (item.prediction && item.prediction.label) || '';

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-pink-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-pink-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${matchday}
                                    </span>
                                    ${successProb !== null ? `
                                    <span class="text-sm font-semibold">
                                        Probabilit√† successo pronostico: ${successProb}%
                                    </span>
                                    ` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-center">${homeTeam} - ${awayTeam}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Esito suggerito dal modello</h4>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        <div class="font-bold text-indigo-700 text-base">${outcomeLabel || 'Esito non disponibile'}</div>
                                        ${modelProb !== null ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† stimata dal modello: ${modelProb}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${item.hit !== undefined ? `
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${item.hit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.hit ? 'Pronostico corretto' : 'Pronostico errato'}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Questa gara √® stata selezionata perch√© combina una forte probabilit√†
                                    stimata dal modello con una buona affidabilit√† storica dei pronostici.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading top picks:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento delle migliori top gare</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function loadTopPicksNorway() {
            const container = document.getElementById('top-picks-container');
            if (!container) return;

            const matchdayInput = document.getElementById('top-picks-matchday');
            const matchdayValue = matchdayInput && matchdayInput.value ? matchdayInput.value : null;

            let url = `${API_BASE_URL}/norway/predictions/evaluate`;
            if (matchdayValue) {
                url += `?matchday=${encodeURIComponent(matchdayValue)}`;
            }

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare...</p>
                </div>
            `;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !Array.isArray(data.matches) || data.matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara valutata per questa giornata</h3>
                            <p class="text-gray-600">Seleziona un'altra giornata o attendi che siano disponibili nuove valutazioni.</p>
                        </div>
                    `;
                    return;
                }

                const sorted = data.matches.slice().sort((a, b) => {
                    const accA = typeof a.prediction_success_probability === 'number' ? a.prediction_success_probability : 0;
                    const accB = typeof b.prediction_success_probability === 'number' ? b.prediction_success_probability : 0;
                    return accB - accA;
                });

                const minSuccessThreshold = 70;
                const maxTopMatches = 6;

                const topMatches = sorted.filter(m => {
                    const acc = typeof m.prediction_success_probability === 'number' ? m.prediction_success_probability : 0;
                    return acc >= minSuccessThreshold;
                }).slice(0, maxTopMatches);

                if (topMatches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara con alta probabilit√† di successo</h3>
                            <p class="text-gray-600">Per questa giornata il modello non ha individuato pronostici davvero affidabili.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (typeof data.overall_accuracy === 'number') {
                    const overallPct = Math.round(data.overall_accuracy * 100);
                    const leagueStats = history2025Stats
                        ? (history2025Stats.norway || history2025Stats.overall)
                        : null;
                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 Eliteserien: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† pronostici giornata Norvegia</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">${overallPct}% successo complessivo</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Basata su ${data.matches_evaluated || data.matches.length} partite valutate
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">
                                        Selezione delle gare con maggiore probabilit√† storica di pronostico corretto
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const item of topMatches) {
                    const homeTeam = item.home_team || (item.match && item.match.home_team) || 'Casa';
                    const awayTeam = item.away_team || (item.match && item.match.away_team) || 'Trasferta';
                    const matchday = item.matchday || (item.match && item.match.matchday) || data.matchday || '-';

                    const successProb = typeof item.prediction_success_probability === 'number'
                        ? Math.round(item.prediction_success_probability)
                        : null;

                    const modelProb = typeof item.predicted_outcome_probability === 'number'
                        ? Math.round(item.predicted_outcome_probability)
                        : null;

                    const outcomeLabel = item.predicted_outcome || (item.prediction && item.prediction.label) || '';

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-pink-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-pink-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${matchday}
                                    </span>
                                    ${successProb !== null ? `
                                    <span class="text-sm font-semibold">
                                        Probabilit√† successo pronostico: ${successProb}%
                                    </span>
                                    ` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-center">${homeTeam} - ${awayTeam}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Esito suggerito dal modello</h4>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        <div class="font-bold text-indigo-700 text-base">${outcomeLabel || 'Esito non disponibile'}</div>
                                        ${modelProb !== null ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† stimata dal modello: ${modelProb}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${item.hit !== undefined ? `
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${item.hit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.hit ? 'Pronostico corretto' : 'Pronostico errato'}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Questa gara √® stata selezionata perch√© combina una forte probabilit√†
                                    stimata dal modello con una buona affidabilit√† storica dei pronostici.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading top picks Norway:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento delle migliori top gare Norvegia</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function loadTopPicksPremier() {
            const container = document.getElementById('top-picks-container');
            if (!container) return;

            const matchdayInput = document.getElementById('top-picks-matchday');
            const matchdayValue = matchdayInput && matchdayInput.value ? matchdayInput.value : null;

            let url = `${API_BASE_URL}/predictions/evaluate/premier`;
            if (matchdayValue) {
                url += `?matchday=${encodeURIComponent(matchdayValue)}`;
            }

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare Premier League...</p>
                </div>
            `;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !Array.isArray(data.matches) || data.matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara valutata per questa giornata</h3>
                            <p class="text-gray-600">Seleziona un'altra giornata o attendi che siano disponibili nuove valutazioni.</p>
                        </div>
                    `;
                    return;
                }

                const sorted = data.matches.slice().sort((a, b) => {
                    const accA = typeof a.prediction_success_probability === 'number' ? a.prediction_success_probability : 0;
                    const accB = typeof b.prediction_success_probability === 'number' ? b.prediction_success_probability : 0;
                    return accB - accA;
                });

                const minSuccessThreshold = 70;
                const maxTopMatches = 6;

                const topMatches = sorted.filter(m => {
                    const acc = typeof m.prediction_success_probability === 'number' ? m.prediction_success_probability : 0;
                    return acc >= minSuccessThreshold;
                }).slice(0, maxTopMatches);

                if (topMatches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara con alta probabilit√† di successo</h3>
                            <p class="text-gray-600">Per questa giornata il modello non ha individuato pronostici davvero affidabili.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (typeof data.overall_accuracy === 'number') {
                    const overallPct = Math.round(data.overall_accuracy * 100);
                    const leagueStats = history2025Stats
                        ? (history2025Stats.premier || history2025Stats.overall)
                        : null;
                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 Premier League: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† pronostici giornata Premier League</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">${overallPct}% successo complessivo</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Basata su ${data.matches_evaluated || data.matches.length} partite valutate
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">
                                        Selezione delle gare con maggiore probabilit√† storica di pronostico corretto
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const item of topMatches) {
                    const homeTeam = item.home_team || (item.match && item.match.home_team) || 'Casa';
                    const awayTeam = item.away_team || (item.match && item.match.away_team) || 'Trasferta';
                    const matchday = item.matchday || (item.match && item.match.matchday) || data.matchday || '-';

                    const successProb = typeof item.prediction_success_probability === 'number'
                        ? Math.round(item.prediction_success_probability)
                        : null;

                    const modelProb = typeof item.predicted_outcome_probability === 'number'
                        ? Math.round(item.predicted_outcome_probability)
                        : null;

                    const outcomeLabel = item.predicted_outcome || (item.prediction && item.prediction.label) || '';

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-pink-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-pink-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${matchday}
                                    </span>
                                    ${successProb !== null ? `
                                    <span class="text-sm font-semibold">
                                        Probabilit√† successo pronostico: ${successProb}%
                                    </span>
                                    ` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-center">${homeTeam} - ${awayTeam}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Esito suggerito dal modello</h4>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        <div class="font-bold text-indigo-700 text-base">${outcomeLabel || 'Esito non disponibile'}</div>
                                        ${modelProb !== null ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† stimata dal modello: ${modelProb}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${item.hit !== undefined ? `
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${item.hit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.hit ? 'Pronostico corretto' : 'Pronostico errato'}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Questa gara √® stata selezionata perch√© combina una forte probabilit√†
                                    stimata dal modello con una buona affidabilit√† storica dei pronostici.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading top picks Premier League:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento delle migliori top gare Premier League</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function loadTopPicksBundesliga() {
            const container = document.getElementById('top-picks-container');
            if (!container) return;

            const matchdayInput = document.getElementById('top-picks-matchday');
            const matchdayValue = matchdayInput && matchdayInput.value ? matchdayInput.value : null;

            let url = `${API_BASE_URL}/predictions/evaluate/bundesliga`;
            if (matchdayValue) {
                url += `?matchday=${encodeURIComponent(matchdayValue)}`;
            }

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare Bundesliga...</p>
                </div>
            `;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !Array.isArray(data.matches) || data.matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara valutata per questa giornata</h3>
                            <p class="text-gray-600">Seleziona un'altra giornata o attendi che siano disponibili nuove valutazioni.</p>
                        </div>
                    `;
                    return;
                }

                const sorted = data.matches.slice().sort((a, b) => {
                    const accA = typeof a.prediction_success_probability === 'number' ? a.prediction_success_probability : 0;
                    const accB = typeof b.prediction_success_probability === 'number' ? b.prediction_success_probability : 0;
                    return accB - accA;
                });

                const minSuccessThreshold = 70;
                const maxTopMatches = 6;

                const topMatches = sorted.filter(m => {
                    const acc = typeof m.prediction_success_probability === 'number' ? m.prediction_success_probability : 0;
                    return acc >= minSuccessThreshold;
                }).slice(0, maxTopMatches);

                if (topMatches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara con alta probabilit√† di successo</h3>
                            <p class="text-gray-600">Per questa giornata il modello non ha individuato pronostici davvero affidabili.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (typeof data.overall_accuracy === 'number') {
                    const overallPct = Math.round(data.overall_accuracy * 100);
                    const leagueStats = history2025Stats
                        ? (history2025Stats.bundesliga || history2025Stats.overall)
                        : null;
                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 Bundesliga: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† pronostici giornata Bundesliga</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">${overallPct}% successo complessivo</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Basata su ${data.matches_evaluated || data.matches.length} partite valutate
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">
                                        Selezione delle gare con maggiore probabilit√† storica di pronostico corretto
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const item of topMatches) {
                    const homeTeam = item.home_team || (item.match && item.match.home_team) || 'Casa';
                    const awayTeam = item.away_team || (item.match && item.match.away_team) || 'Trasferta';
                    const matchday = item.matchday || (item.match && item.match.matchday) || data.matchday || '-';

                    const successProb = typeof item.prediction_success_probability === 'number'
                        ? Math.round(item.prediction_success_probability)
                        : null;

                    const modelProb = typeof item.predicted_outcome_probability === 'number'
                        ? Math.round(item.predicted_outcome_probability)
                        : null;

                    const outcomeLabel = item.predicted_outcome || (item.prediction && item.prediction.label) || '';

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-pink-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-pink-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${matchday}
                                    </span>
                                    ${successProb !== null ? `
                                    <span class="text-sm font-semibold">
                                        Probabilit√† successo pronostico: ${successProb}%
                                    </span>
                                    ` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-center">${homeTeam} - ${awayTeam}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Esito suggerito dal modello</h4>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        <div class="font-bold text-indigo-700 text-base">${outcomeLabel || 'Esito non disponibile'}</div>
                                        ${modelProb !== null ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† stimata dal modello: ${modelProb}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${item.hit !== undefined ? `
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${item.hit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.hit ? 'Pronostico corretto' : 'Pronostico errato'}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Questa gara √® stata selezionata perch√© combina una forte probabilit√†
                                    stimata dal modello con una buona affidabilit√† storica dei pronostici.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading top picks Bundesliga:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento delle migliori top gare Bundesliga</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function loadTopPicksLaLiga() {
            const container = document.getElementById('top-picks-container');
            if (!container) return;

            const matchdayInput = document.getElementById('top-picks-matchday');
            const matchdayValue = matchdayInput && matchdayInput.value ? matchdayInput.value : null;

            let url = `${API_BASE_URL}/predictions/evaluate/laliga`;
            if (matchdayValue) {
                url += `?matchday=${encodeURIComponent(matchdayValue)}`;
            }

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento migliori top gare La Liga...</p>
                </div>
            `;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !Array.isArray(data.matches) || data.matches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara valutata per questa giornata</h3>
                            <p class="text-gray-600">Seleziona un'altra giornata o attendi che siano disponibili nuove valutazioni.</p>
                        </div>
                    `;
                    return;
                }

                const sorted = data.matches.slice().sort((a, b) => {
                    const accA = typeof a.prediction_success_probability === 'number' ? a.prediction_success_probability : 0;
                    const accB = typeof b.prediction_success_probability === 'number' ? b.prediction_success_probability : 0;
                    return accB - accA;
                });

                const minSuccessThreshold = 70;
                const maxTopMatches = 6;

                const topMatches = sorted.filter(m => {
                    const acc = typeof m.prediction_success_probability === 'number' ? m.prediction_success_probability : 0;
                    return acc >= minSuccessThreshold;
                }).slice(0, maxTopMatches);

                if (topMatches.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">Nessuna gara con alta probabilit√† di successo</h3>
                            <p class="text-gray-600">Per questa giornata il modello non ha individuato pronostici davvero affidabili.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (typeof data.overall_accuracy === 'number') {
                    const overallPct = Math.round(data.overall_accuracy * 100);
                    const leagueStats = history2025Stats
                        ? (history2025Stats.laliga || history2025Stats.overall)
                        : null;
                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 La Liga: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† pronostici giornata La Liga</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">${overallPct}% successo complessivo</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Basata su ${data.matches_evaluated || data.matches.length} partite valutate
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-pink-100 text-pink-800">
                                        Selezione delle gare con maggiore probabilit√† storica di pronostico corretto
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const item of topMatches) {
                    const homeTeam = item.home_team || (item.match && item.match.home_team) || 'Casa';
                    const awayTeam = item.away_team || (item.match && item.match.away_team) || 'Trasferta';
                    const matchday = item.matchday || (item.match && item.match.matchday) || data.matchday || '-';

                    const successProb = typeof item.prediction_success_probability === 'number'
                        ? Math.round(item.prediction_success_probability)
                        : null;

                    const modelProb = typeof item.predicted_outcome_probability === 'number'
                        ? Math.round(item.predicted_outcome_probability)
                        : null;

                    const outcomeLabel = item.predicted_outcome || (item.prediction && item.prediction.label) || '';

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-pink-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-pink-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${matchday}
                                    </span>
                                    ${successProb !== null ? `
                                    <span class="text-sm font-semibold">
                                        Probabilit√† successo pronostico: ${successProb}%
                                    </span>
                                    ` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-center">${homeTeam} - ${awayTeam}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Esito suggerito dal modello</h4>
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        <div class="font-bold text-indigo-700 text-base">${outcomeLabel || 'Esito non disponibile'}</div>
                                        ${modelProb !== null ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† stimata dal modello: ${modelProb}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${item.hit !== undefined ? `
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${item.hit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.hit ? 'Pronostico corretto' : 'Pronostico errato'}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Questa gara √® stata selezionata perch√© combina una forte probabilit√†
                                    stimata dal modello con una buona affidabilit√† storica dei pronostici.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading top picks La Liga:', error);
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento delle migliori top gare La Liga</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function renderPlayableMatchesForLeague(predictionsUrl, reliabilityUrl, leagueLabel, headerTitle) {
            const container = document.getElementById('playable-container');
            if (!container) return;

            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto"></div>
                    <p class="text-gray-600 mt-4">Caricamento gare da giocare...</p>
                </div>
            `;

            try {
                const [predictionsResponse, reliabilityResponse] = await Promise.all([
                    fetch(predictionsUrl, {
                        headers: {
                            'X-API-Key': API_KEY
                        }
                    }),
                    fetch(reliabilityUrl, {
                        headers: {
                            'X-API-Key': API_KEY
                        }
                    }).catch(() => null)
                ]);

                const data = await predictionsResponse.json();
                let reliability = null;
                if (reliabilityResponse && reliabilityResponse.ok) {
                    try {
                        reliability = await reliabilityResponse.json();
                    } catch (e) {
                        reliability = null;
                    }
                }

                if (!Array.isArray(data) || data.length === 0) {
                    const noDataTitle = leagueLabel === 'Eliteserien'
                        ? 'Nessuna gara disponibile da giocare in Eliteserien'
                        : 'Nessuna gara disponibile da giocare';
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚è∞</div>
                            <h3 class="text-xl font-semibold text-gray-700">${noDataTitle}</h3>
                            <p class="text-gray-600">Torna pi√π tardi per le prossime gare consigliate.</p>
                        </div>
                    `;
                    return;
                }

                let modelAccuracyPct = null;
                if (reliability && typeof reliability.accuracy === 'number') {
                    modelAccuracyPct = Math.round(reliability.accuracy * 100);
                }

                const scored = data.map(match => {
                    const p = match.prediction;
                    const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                    return { match, maxProb };
                }).sort((a, b) => b.maxProb - a.maxProb);

                const maxTopMatches = 3;
                const minProbForTopPick = 70;
                const minAccuracyForTopPick = 60;

                const topMatches = [];
                for (const item of scored) {
                    if (topMatches.length >= maxTopMatches) break;
                    const passesProb = item.maxProb >= minProbForTopPick;
                    const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                    if (passesProb && passesAccuracy) {
                        topMatches.push(item.match);
                    }
                }

                if (topMatches.length === 0) {
                    const noHighProbTitle = leagueLabel === 'Eliteserien'
                        ? 'Nessuna gara con alta probabilit√† per la prossima giornata in Eliteserien'
                        : 'Nessuna gara con alta probabilit√† per la prossima giornata';
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-xl font-semibold text-gray-700">${noHighProbTitle}</h3>
                            <p class="text-gray-600">Il modello non individua al momento tre gare davvero forti su cui puntare.</p>
                        </div>
                    `;
                    return;
                }

                const blocks = [];

                if (modelAccuracyPct !== null) {
                    let leagueStats = null;
                    if (history2025Stats) {
                        if (leagueLabel === 'Serie A') {
                            leagueStats = history2025Stats.seriea || history2025Stats.overall;
                        } else if (leagueLabel === 'Eliteserien') {
                            leagueStats = history2025Stats.norway || history2025Stats.overall;
                        } else if (leagueLabel === 'Premier League') {
                            leagueStats = history2025Stats.premier || history2025Stats.overall;
                        } else if (leagueLabel === 'Bundesliga') {
                            leagueStats = history2025Stats.bundesliga || history2025Stats.overall;
                        } else if (leagueLabel === 'La Liga') {
                            leagueStats = history2025Stats.laliga || history2025Stats.overall;
                        } else {
                            leagueStats = history2025Stats.overall;
                        }
                    }

                    const historyBadge = leagueStats
                        ? `<span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 ml-2">
                               Storico 2025 ${leagueLabel}: ${(leagueStats.accuracy * 100).toFixed(1)}% su ${leagueStats.matches} partite
                           </span>`
                        : '';
                    blocks.push(`
                        <div class="col-span-full mb-4">
                            <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                                <div>
                                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">${headerTitle}</div>
                                    <div class="text-2xl font-bold text-gray-800 mt-1">Affidabilit√† modello: ${modelAccuracyPct}%</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Selezione automatica delle tre gare pi√π promettenti della prossima giornata.
                                        ${historyBadge}
                                    </div>
                                </div>
                                <div class="mt-3 md:mt-0">
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-800">
                                        Campione pensato per concentrare le giocate su pochi eventi forti
                                    </span>
                                </div>
                            </div>
                        </div>
                    `);
                }

                for (const match of topMatches) {
                    const p = match.prediction;
                    const kickoff = match.kickoff ? new Date(match.kickoff) : null;
                    const kickoffText = kickoff ? kickoff.toLocaleString('it-IT', {
                        weekday: 'short',
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                    const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                    let outcome = '1';
                    let fairOdds = p.home_fair_odds;
                    if (maxProb === p.draw_prob) {
                        outcome = 'X';
                        fairOdds = p.draw_fair_odds;
                    } else if (maxProb === p.away_win_prob) {
                        outcome = '2';
                        fairOdds = p.away_fair_odds;
                    }

                    const hasXg = p.expected_goals && typeof p.expected_goals.home === 'number' && typeof p.expected_goals.away === 'number';
                    const totalXg = hasXg ? p.expected_goals.total : null;

                    blocks.push(`
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden ring-2 ring-emerald-400 ring-offset-1">
                            <div class="card-gradient text-white p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="bg-white text-emerald-600 px-2 py-1 rounded text-sm font-bold">
                                        Giornata ${match.matchday || '-'}
                                    </span>
                                    <span class="text-sm">${kickoffText}</span>
                                </div>
                                <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                            </div>

                            <div class="p-4 border-b">
                                <h4 class="font-semibold text-gray-700 mb-2">Suggerimento principale</h4>
                                <div class="space-y-2 text-sm text-gray-700">
                                    <div>
                                        <div class="font-bold text-emerald-700 text-base">Segno ${outcome}</div>
                                        <div class="text-xs text-gray-600 mt-1">
                                            Probabilit√† pi√π alta tra 1-X-2: ${maxProb}%
                                        </div>
                                        ${modelAccuracyPct !== null ? `
                                        <div class="text-xs text-gray-500 mt-1">
                                            Contestualizzato con affidabilit√† modello: ${modelAccuracyPct}%
                                        </div>
                                        ` : ''}
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-gray-600">
                                        <div>
                                            <div class="font-semibold text-gray-700 mb-1">Fair odds</div>
                                            <div>
                                                Segno ${outcome}: 
                                                <span class="font-bold">${fairOdds !== null && fairOdds !== undefined ? fairOdds : '-'}</span>
                                            </div>
                                        </div>
                                        ${hasXg ? `
                                        <div>
                                            <div class="font-semibold text-gray-700 mb-1">Goal attesi</div>
                                            <div>${match.home_team}: <span class="font-bold">${p.expected_goals.home}</span></div>
                                            <div>${match.away_team}: <span class="font-bold">${p.expected_goals.away}</span></div>
                                            <div>Totale: <span class="font-bold">${totalXg}</span></div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 text-sm text-gray-600">
                                <p>
                                    Gara selezionata come parte del campione top ${leagueLabel},
                                    combinando probabilit√† elevata del modello, fair odds e goal attesi.
                                </p>
                            </div>
                        </div>
                    `);
                }

                container.innerHTML = blocks.join('');
            } catch (error) {
                console.error('Error loading playable matches for league:', error);
                const errorTitle = leagueLabel === 'Eliteserien'
                    ? 'Errore nel caricamento delle gare da giocare in Eliteserien'
                    : 'Errore nel caricamento delle gare da giocare';
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">${errorTitle}</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console per maggiori dettagli.</p>
                    </div>
                `;
            }
        }

        async function loadPlayableMatches() {
            await renderPlayableMatchesForLeague(
                `${API_BASE_URL}/detailed/matches/next/predictions`,
                `${API_BASE_URL}/predictions/reliability/seriea?last_n_matchdays=18`,
                'Serie A',
                'Campione top Serie A'
            );
        }

        async function loadPlayableMatchesNorway() {
            await renderPlayableMatchesForLeague(
                `${API_BASE_URL}/detailed/matches/next/predictions/norway`,
                `${API_BASE_URL}/norway/predictions/reliability?last_n_matchdays=18`,
                'Eliteserien',
                'Campione top Eliteserien'
            );
        }

        async function loadPlayableMatchesPremier() {
            await renderPlayableMatchesForLeague(
                `${API_BASE_URL}/detailed/matches/next/predictions/premier`,
                `${API_BASE_URL}/predictions/reliability/premier?last_n_matchdays=18`,
                'Premier League',
                'Campione top Premier League'
            );
        }

        async function loadPlayableMatchesBundesliga() {
            await renderPlayableMatchesForLeague(
                `${API_BASE_URL}/detailed/matches/next/predictions/bundesliga`,
                `${API_BASE_URL}/predictions/reliability/bundesliga?last_n_matchdays=18`,
                'Bundesliga',
                'Campione top Bundesliga'
            );
        }

        async function loadPlayableMatchesLaLiga() {
            await renderPlayableMatchesForLeague(
                `${API_BASE_URL}/detailed/matches/next/predictions/laliga`,
                `${API_BASE_URL}/predictions/reliability/laliga?last_n_matchdays=18`,
                'La Liga',
                'Campione top La Liga'
            );
        }

        async function loadModelQuality(league) {
            const container = document.getElementById('model-quality-container');
            if (!container) return;

            let url;
            let title;
            if (league === 'norway') {
                url = `${API_BASE_URL}/norway/predictions/evaluate`;
                title = 'üéØ Qualit√† Modello Norvegia';
            } else {
                url = `${API_BASE_URL}/predictions/evaluate/seriea`;
                title = 'üéØ Qualit√† Modello Serie A';
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                if (!data || !data.matches_evaluated || data.matches_evaluated === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 h-full">
                            <h3 class="font-semibold text-gray-700 mb-2">${title}</h3>
                            <p class="text-sm text-gray-600">Nessuna partita valutata di recente.</p>
                            <p class="text-xs text-gray-400 mt-2">Le metriche saranno disponibili dopo che alcune partite saranno concluse.</p>
                        </div>
                    `;
                    return;
                }

                const accuracyPct = (data.accuracy * 100).toFixed(1);
                const brier = data.brier_score_mean.toFixed(3);
                const logLoss = data.log_loss_mean.toFixed(3);

                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">${title}</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Partite valutate:</span>
                                <span class="font-bold">${data.matches_evaluated}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Accuracy segno 1-X-2:</span>
                                <span class="font-bold text-green-600">${accuracyPct}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Brier score medio:</span>
                                <span class="font-bold">${brier}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Log loss media:</span>
                                <span class="font-bold">${logLoss}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">
                            Valori aggiornati sulle ultime partite concluse, basati su probabilit√† pre-gara.
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading model quality:', error);
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">${title}</h3>
                        <p class="text-sm text-red-600">Errore nel caricamento della qualit√† modello.</p>
                    </div>
                `;
            }
        }

        async function loadHistory2025Stats() {
            const container = document.getElementById('history-2025-container');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE_URL}/predictions/history/2025`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();

                const hasOverall = data && typeof data.matches_2025 === 'number' && data.matches_2025 > 0;
                const overallStats = hasOverall
                    ? {
                        matches: data.matches_2025,
                        accuracy: typeof data.accuracy_2025 === 'number' ? data.accuracy_2025 : 0
                    }
                    : null;

                const serieAData = data && data.seriea && typeof data.seriea.matches_2025 === 'number' && data.seriea.matches_2025 > 0
                    ? {
                        matches: data.seriea.matches_2025,
                        accuracy: typeof data.seriea.accuracy_2025 === 'number' ? data.seriea.accuracy_2025 : 0
                    }
                    : null;

                const norwayData = data && data.norway && typeof data.norway.matches_2025 === 'number' && data.norway.matches_2025 > 0
                    ? {
                        matches: data.norway.matches_2025,
                        accuracy: typeof data.norway.accuracy_2025 === 'number' ? data.norway.accuracy_2025 : 0
                    }
                    : null;

                const premierData = data && data.premier && typeof data.premier.matches_2025 === 'number' && data.premier.matches_2025 > 0
                    ? {
                        matches: data.premier.matches_2025,
                        accuracy: typeof data.premier.accuracy_2025 === 'number' ? data.premier.accuracy_2025 : 0
                    }
                    : null;

                const bundesligaData = data && data.bundesliga && typeof data.bundesliga.matches_2025 === 'number' && data.bundesliga.matches_2025 > 0
                    ? {
                        matches: data.bundesliga.matches_2025,
                        accuracy: typeof data.bundesliga.accuracy_2025 === 'number' ? data.bundesliga.accuracy_2025 : 0
                    }
                    : null;

                const laligaData = data && data.laliga && typeof data.laliga.matches_2025 === 'number' && data.laliga.matches_2025 > 0
                    ? {
                        matches: data.laliga.matches_2025,
                        accuracy: typeof data.laliga.accuracy_2025 === 'number' ? data.laliga.accuracy_2025 : 0
                    }
                    : null;

                history2025Stats = overallStats || serieAData || norwayData || premierData || bundesligaData || laligaData
                    ? {
                        overall: overallStats,
                        seriea: serieAData,
                        norway: norwayData,
                        premier: premierData,
                        bundesliga: bundesligaData,
                        laliga: laligaData
                    }
                    : null;

                if (!history2025Stats) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 h-full">
                            <h3 class="font-semibold text-gray-700 mb-2">üìÖ Storico 2025</h3>
                            <p class="text-sm text-gray-600">Nessuna partita disponibile nel periodo agosto-dicembre 2025.</p>
                        </div>
                    `;
                    return;
                }

                const overall = history2025Stats.overall;
                const seriea = history2025Stats.seriea;
                const norway = history2025Stats.norway;
                const premier = history2025Stats.premier;
                const bundesliga = history2025Stats.bundesliga;
                const laliga = history2025Stats.laliga;

                const overallLine = overall ? `
                    <div class="flex justify-between">
                        <span>Totale partite agosto-dicembre 2025:</span>
                        <span class="font-bold">${overall.matches}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Accuracy complessiva segno 1-X-2:</span>
                        <span class="font-bold text-blue-600">${(overall.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                const serieaLine = seriea ? `
                    <div class="flex justify-between">
                        <span>Serie A (partite agosto-dicembre 2025):</span>
                        <span class="font-bold">${seriea.matches} ‚Äì ${(seriea.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                const norwayLine = norway ? `
                    <div class="flex justify-between">
                        <span>Eliteserien (partite agosto-dicembre 2025):</span>
                        <span class="font-bold">${norway.matches} ‚Äì ${(norway.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                const premierLine = premier ? `
                    <div class="flex justify-between">
                        <span>Premier League (partite agosto-dicembre 2025):</span>
                        <span class="font-bold">${premier.matches} ‚Äì ${(premier.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                const bundesligaLine = bundesliga ? `
                    <div class="flex justify-between">
                        <span>Bundesliga (partite agosto-dicembre 2025):</span>
                        <span class="font-bold">${bundesliga.matches} ‚Äì ${(bundesliga.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                const laligaLine = laliga ? `
                    <div class="flex justify-between">
                        <span>La Liga (partite agosto-dicembre 2025):</span>
                        <span class="font-bold">${laliga.matches} ‚Äì ${(laliga.accuracy * 100).toFixed(1)}%</span>
                    </div>
                ` : '';

                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">üìÖ Storico 2025</h3>
                        <div class="space-y-2 text-sm">
                            ${overallLine}
                            ${serieaLine}
                            ${norwayLine}
                            ${premierLine}
                            ${bundesligaLine}
                            ${laligaLine}
                        </div>
                        <p class="text-xs text-gray-400 mt-3">
                            Dati agosto‚Äìdicembre 2025, separati per campionato quando disponibili.
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading 2025 history stats:', error);
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">üìÖ Storico 2025</h3>
                        <p class="text-sm text-red-600">Errore nel caricamento dello storico 2025.</p>
                    </div>
                `;
            }
        }

        async function loadHistoryProgressStats() {
            const container = document.getElementById('history-progress-container');
            if (!container) return;

            try {
                const response2025 = await fetch(`${API_BASE_URL}/predictions/history/2025`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data2025 = await response2025.json();

                const response2026 = await fetch(`${API_BASE_URL}/predictions/history/2026`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data2026 = await response2026.json();

                const acc2025 = typeof data2025.accuracy_2025 === 'number' ? data2025.accuracy_2025 : 0;
                const matches2025 = typeof data2025.matches_2025 === 'number' ? data2025.matches_2025 : 0;

                const acc2026 = typeof data2026.accuracy_2026 === 'number' ? data2026.accuracy_2026 : 0;
                const matches2026 = typeof data2026.matches_2026 === 'number' ? data2026.matches_2026 : 0;

                if (matches2025 === 0 && matches2026 === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 h-full">
                            <h3 class="font-semibold text-gray-700 mb-2">üìä Confronto 2025 vs 2026</h3>
                            <p class="text-sm text-gray-600">Non ci sono ancora abbastanza partite per un confronto significativo.</p>
                        </div>
                    `;
                    return;
                }

                const delta = (acc2026 - acc2025) * 100;
                const trendLabel = delta > 0
                    ? `+${delta.toFixed(1)} punti percentuali rispetto al blocco 2025`
                    : `${delta.toFixed(1)} punti percentuali rispetto al blocco 2025`;

                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">üìä Confronto 2025 vs 2026</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Storico 2025 (ago‚Äìdic):</span>
                                <span class="font-bold">${matches2025} partite ‚Äì ${(acc2025 * 100).toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Stagione 2026 (da 1 gennaio):</span>
                                <span class="font-bold">${matches2026} partite ‚Äì ${(acc2026 * 100).toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Andamento 2026 vs blocco 2025:</span>
                                <span class="font-bold ${delta >= 0 ? 'text-green-600' : 'text-red-600'}">${trendLabel}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">
                            Le partite 2026 vengono aggiunte progressivamente man mano che si concludono, in allineamento con il training del modello.
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading progress history stats:', error);
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-4 h-full">
                        <h3 class="font-semibold text-gray-700 mb-2">üìä Confronto 2025 vs 2026</h3>
                        <p class="text-sm text-red-600">Errore nel caricamento del confronto 2025/2026.</p>
                    </div>
                `;
            }
        }

        // Load live matches with detailed cards
        async function loadLiveMatches() {
            const response = await fetch(`${API_BASE_URL}/detailed/matches/live/cards`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('live-matches-container');
            
            // Check if data is an array, if not show error
            if (!Array.isArray(data)) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento dati</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console</p>
                    </div>
                `;
                console.error('API returned non-array data:', data);
                return;
            }
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in corso</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le partite live</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = data.map(match => `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <!-- Match Header -->
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                ${match.minute ? `${match.minute}'` : match.status}
                            </span>
                            <span class="text-sm">${match.score || 'VS'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                    </div>
                    
                    <!-- Prediction -->
                    <div class="p-4 border-b">
                        <h4 class="font-semibold text-gray-700 mb-2">üìä Pronostico</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-red-100 p-2 rounded">
                                <div class="text-sm text-red-600">1</div>
                                <div class="font-bold text-red-700">${match.prediction.home_win_prob}%</div>
                                ${match.prediction.home_fair_odds ? `<div class="text-xs text-red-700 mt-1">q. fair ${match.prediction.home_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-gray-100 p-2 rounded">
                                <div class="text-sm text-gray-600">X</div>
                                <div class="font-bold text-gray-700">${match.prediction.draw_prob}%</div>
                                ${match.prediction.draw_fair_odds ? `<div class="text-xs text-gray-700 mt-1">q. fair ${match.prediction.draw_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <div class="text-sm text-blue-600">2</div>
                                <div class="font-bold text-blue-700">${match.prediction.away_win_prob}%</div>
                                ${match.prediction.away_fair_odds ? `<div class="text-xs text-blue-700 mt-1">q. fair ${match.prediction.away_fair_odds}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-center mt-2 text-sm text-gray-600">
                            Probabile: ${match.prediction.most_likely_scoreline}
                        </div>
                    </div>
                    
                    <!-- Expected Goals -->
                    <div class="p-4 border-b">
                        <h4 class="font-semibold text-gray-700 mb-2">üéØ Goal Attesi</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">${match.home_team}:</span>
                            <span class="font-bold">${match.prediction.expected_goals.home}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">${match.away_team}:</span>
                            <span class="font-bold">${match.prediction.expected_goals.away}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">Totale:</span>
                            <span class="font-bold">${match.prediction.expected_goals.total}</span>
                        </div>
                    </div>
                    
                    <!-- Bio Rhythm -->
                    <div class="p-4">
                        <h4 class="font-semibold text-gray-700 mb-2">‚≠ê Bioritmo Calciatori</h4>
                        ${Object.entries(match.bio_rhythm_analysis).slice(0, 3).map(([player, rhythm]) => `
                            <div class="mb-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium">${player}</span>
                                    <span class="font-bold ${getRhythmColor(rhythm.overall)}">${rhythm.overall}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${rhythm.overall}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function loadLiveMatchesNorway() {
            const response = await fetch(`${API_BASE_URL}/detailed/matches/live/cards/norway`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();

            const container = document.getElementById('live-matches-container');

            if (!Array.isArray(data)) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento dati Norvegia</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console</p>
                    </div>
                `;
                console.error('API Norway live cards returned non-array data:', data);
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in corso in Eliteserien</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le partite live</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(match => `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                ${match.minute ? `${match.minute}'` : match.status}
                            </span>
                            <span class="text-sm">${match.score || 'VS'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                    </div>

                    <div class="p-4 border-b">
                        <h4 class="font-semibold text-gray-700 mb-2">üìä Pronostico</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-red-100 p-2 rounded">
                                <div class="text-sm text-red-600">1</div>
                                <div class="font-bold text-red-700">${match.prediction.home_win_prob}%</div>
                                ${match.prediction.home_fair_odds ? `<div class="text-xs text-red-700 mt-1">q. fair ${match.prediction.home_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-gray-100 p-2 rounded">
                                <div class="text-sm text-gray-600">X</div>
                                <div class="font-bold text-gray-700">${match.prediction.draw_prob}%</div>
                                ${match.prediction.draw_fair_odds ? `<div class="text-xs text-gray-700 mt-1">q. fair ${match.prediction.draw_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <div class="text-sm text-blue-600">2</div>
                                <div class="font-bold text-blue-700">${match.prediction.away_win_prob}%</div>
                                ${match.prediction.away_fair_odds ? `<div class="text-xs text-blue-700 mt-1">q. fair ${match.prediction.away_fair_odds}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-center mt-2 text-sm text-gray-600">
                            Probabile: ${match.prediction.most_likely_scoreline}
                        </div>
                    </div>

                    <div class="p-4 border-b">
                        <h4 class="font-semibold text-gray-700 mb-2">üéØ Goal Attesi</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">${match.home_team}:</span>
                            <span class="font-bold">${match.prediction.expected_goals.home}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">${match.away_team}:</span>
                            <span class="font-bold">${match.prediction.expected_goals.away}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">Totale:</span>
                            <span class="font-bold">${match.prediction.expected_goals.total}</span>
                        </div>
                    </div>

                    <div class="p-4">
                        <h4 class="font-semibold text-gray-700 mb-2">‚≠ê Bioritmo Calciatori</h4>
                        ${Object.entries(match.bio_rhythm_analysis).slice(0, 3).map(([player, rhythm]) => `
                            <div class="mb-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium">${player}</span>
                                    <span class="font-bold ${getRhythmColor(rhythm.overall)}">${rhythm.overall}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${rhythm.overall}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function loadLiveMatchesPremier() {
            const response = await fetch(`${API_BASE_URL}/detailed/matches/live/cards/premier`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();

            const container = document.getElementById('live-matches-container');

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in corso in Premier League</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le partite live</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(match => `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                ${match.minute ? `${match.minute}'` : match.status}
                            </span>
                            <span class="text-sm">${match.score || 'VS'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                    </div>
                </div>
            `).join('');
        }

        async function loadLiveMatchesBundesliga() {
            const response = await fetch(`${API_BASE_URL}/detailed/matches/live/cards/bundesliga`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();

            const container = document.getElementById('live-matches-container');

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in corso in Bundesliga</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le partite live</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(match => `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                ${match.minute ? `${match.minute}'` : match.status}
                            </span>
                            <span class="text-sm">${match.score || 'VS'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                    </div>
                </div>
            `).join('');
        }

        async function loadLiveMatchesLaLiga() {
            const response = await fetch(`${API_BASE_URL}/detailed/matches/live/cards/laliga`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();

            const container = document.getElementById('live-matches-container');

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in corso in La Liga</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le partite live</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(match => `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                ${match.minute ? `${match.minute}'` : match.status}
                            </span>
                            <span class="text-sm">${match.score || 'VS'}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                    </div>
                </div>
            `).join('');
        }

        let lastPredictionsSerieA = null;
        let lastReliabilitySerieA = null;
        let lastHighlightedIdsSerieA = null;

        let lastPredictionsNorway = null;
        let lastReliabilityNorway = null;
        let lastHighlightedIdsNorway = null;

        function isOnlyTopPicksEnabled() {
            const toggle = document.getElementById('only-top-picks-toggle');
            return toggle && toggle.checked;
        }

        function renderPredictionsGrid(data, reliability, highlightedIds, leagueLabel) {
            const container = document.getElementById('predictions-container');

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in programma</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le previsioni della prossima giornata</p>
                    </div>
                `;
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const blocks = [];

            if (modelAccuracyPct !== null) {
                blocks.push(`
                <div class="col-span-full mb-4">
                    <div class="bg-white rounded-xl shadow p-4 flex flex-col md:flex-row md:items-center md:justify-between">
                        <div>
                            <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Affidabilit√† modello ${leagueLabel}</div>
                            <div class="text-2xl font-bold text-gray-800 mt-1">${modelAccuracyPct}% accuracy</div>
                            <div class="text-xs text-gray-500 mt-1">
                                Basata su ultime ${reliabilityMatchdays || 0} giornate concluse
                                ${matchesEvaluated !== null ? ` ¬∑ ${matchesEvaluated} partite valutate` : ''}
                            </div>
                        </div>
                        <div class="mt-3 md:mt-0">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                Le partite evidenziate in giallo combinano alta probabilit√† e buon storico del modello
                            </span>
                        </div>
                    </div>
                </div>
                `);
            }

            const onlyTop = isOnlyTopPicksEnabled();

            const topMatches = [];
            const otherMatches = [];

            for (const match of data) {
                const p = match.prediction;
                const bio = match.bio_rhythm_analysis || {};
                const lineups = match.expected_lineups || null;
                const isTopPick = highlightedIds && highlightedIds.has(match.match_id);

                if (onlyTop && !isTopPick) {
                    continue;
                }

                const kickoff = match.kickoff ? new Date(match.kickoff) : null;
                const kickoffText = kickoff ? kickoff.toLocaleString('it-IT', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';

                const now = new Date();
                const diffMinutes = kickoff ? (kickoff - now) / 60000 : 0;
                const showPreMatchDetails = kickoff && diffMinutes <= 60;

                const cardHtml = `
                <div class="match-card bg-white rounded-xl shadow-lg overflow-hidden ${isTopPick ? 'ring-2 ring-yellow-400 ring-offset-1' : ''}">
                    <div class="card-gradient text-white p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="bg-white text-blue-600 px-2 py-1 rounded text-sm font-bold">
                                Giornata ${match.matchday || '-'}
                            </span>
                            <span class="text-sm">${kickoffText}</span>
                        </div>
                        <h3 class="text-lg font-bold text-center">${match.home_team} - ${match.away_team}</h3>
                        ${isTopPick && modelAccuracyPct !== null ? `
                        <div class="mt-2 text-center">
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-yellow-300 text-yellow-900">
                                Pronostico ad alta affidabilit√† ¬∑ modello ${modelAccuracyPct}% su ultime ${reliabilityMatchdays || 0} giornate
                            </span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="p-4 border-b">
                        <h4 class="font-semibold text-gray-700 mb-2">${leagueLabel === 'Eliteserien' ? 'üìä Pronostico Eliteserien' : 'üìä Pronostico'}</h4>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-red-100 p-2 rounded">
                                <div class="text-sm text-red-600">1</div>
                                <div class="font-bold text-red-700">${p.home_win_prob}%</div>
                                ${p.home_fair_odds ? `<div class="text-xs text-red-700 mt-1">q. fair ${p.home_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-gray-100 p-2 rounded">
                                <div class="text-sm text-gray-600">X</div>
                                <div class="font-bold text-gray-700">${p.draw_prob}%</div>
                                ${p.draw_fair_odds ? `<div class="text-xs text-gray-700 mt-1">q. fair ${p.draw_fair_odds}</div>` : ''}
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <div class="text-sm text-blue-600">2</div>
                                <div class="font-bold text-blue-700">${p.away_win_prob}%</div>
                                ${p.away_fair_odds ? `<div class="text-xs text-blue-700 mt-1">q. fair ${p.away_fair_odds}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-center mt-2 text-sm text-gray-600">
                            Probabile: ${p.most_likely_scoreline}
                        </div>
                    </div>

                    <div class="p-4">
                        <h4 class="font-semibold text-gray-700 mb-2">üéØ Goal Attesi</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">${match.home_team}:</span>
                            <span class="font-bold">${p.expected_goals.home}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">${match.away_team}:</span>
                            <span class="font-bold">${p.expected_goals.away}</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm">Totale:</span>
                            <span class="font-bold">${p.expected_goals.total}</span>
                        </div>
                    </div>

                    ${showPreMatchDetails && Object.keys(bio).length > 0 ? `
                    <div class="p-4 border-t">
                        <h4 class="font-semibold text-gray-700 mb-2">‚≠ê Bioritmo Calciatori</h4>
                        ${Object.entries(bio).slice(0, 3).map(([player, rhythm]) => `
                            <div class="mb-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium">${player}</span>
                                    <span class="font-bold ${getRhythmColor(rhythm.overall)}">${rhythm.overall}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : `
                    <div class="p-4 border-t text-sm text-gray-500">
                        Dati bioritmo disponibili da circa un'ora prima del calcio d'inizio.
                    </div>
                    `}

                    ${showPreMatchDetails && lineups ? `
                    <div class="p-4 border-t">
                        <h4 class="font-semibold text-gray-700 mb-2">üìã Probabili Formazioni</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-semibold mb-1">${match.home_team}</div>
                                <div>Modulo: ${lineups.home.formation}</div>
                                <div>Allenatore: ${lineups.home.coach}</div>
                            </div>
                            <div>
                                <div class="font-semibold mb-1">${match.away_team}</div>
                                <div>Modulo: ${lineups.away.formation}</div>
                                <div>Allenatore: ${lineups.away.coach}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;

                if (isTopPick) {
                    topMatches.push(cardHtml);
                } else {
                    otherMatches.push(cardHtml);
                }
            }

            if (topMatches.length === 0 && onlyTop) {
                blocks.push(`
                <div class="col-span-full text-center py-8">
                    <h3 class="text-lg font-semibold text-gray-700">Nessun pronostico ad alta affidabilit√† per questa giornata</h3>
                    <p class="text-gray-500 text-sm mt-1">Disattiva il filtro per vedere tutte le partite disponibili.</p>
                </div>
                `);
            }

            blocks.push(...topMatches);
            blocks.push(...otherMatches);

            container.innerHTML = blocks.join('');
        }

        async function loadPredictions() {
            const [predictionsResponse, reliabilityResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/detailed/matches/next/predictions`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }),
                fetch(`${API_BASE_URL}/predictions/reliability/seriea?last_n_matchdays=18`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }).catch(() => null)
            ]);

            const data = await predictionsResponse.json();
            let reliability = null;
            if (reliabilityResponse && reliabilityResponse.ok) {
                try {
                    reliability = await reliabilityResponse.json();
                } catch (e) {
                    reliability = null;
                }
            }

            const container = document.getElementById('predictions-container');

            if (!Array.isArray(data)) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento previsioni</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console</p>
                    </div>
                `;
                console.error('API returned non-array predictions:', data);
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in programma</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le previsioni della prossima giornata</p>
                    </div>
                `;
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const sortedByProb = data.map(match => {
                const p = match.prediction;
                const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                return { match_id: match.match_id, maxProb };
            }).sort((a, b) => b.maxProb - a.maxProb);

            const highlightedIds = new Set();
            const maxTopPicks = 3;
            const minProbForTopPick = 60;
            const minAccuracyForTopPick = 55;

            for (let i = 0; i < Math.min(maxTopPicks, sortedByProb.length); i++) {
                const item = sortedByProb[i];
                const passesProb = item.maxProb >= minProbForTopPick;
                const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                if (passesProb && passesAccuracy) {
                    highlightedIds.add(item.match_id);
                }
            }
            lastPredictionsSerieA = data;
            lastReliabilitySerieA = reliability;
            lastHighlightedIdsSerieA = highlightedIds;

            renderPredictionsGrid(data, reliability, highlightedIds, 'Serie A');
        }

        async function loadPredictionsNorway() {
            const [predictionsResponse, reliabilityResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/detailed/matches/next/predictions/norway`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }),
                fetch(`${API_BASE_URL}/norway/predictions/reliability?last_n_matchdays=18`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }).catch(() => null)
            ]);

            const data = await predictionsResponse.json();
            let reliability = null;
            if (reliabilityResponse && reliabilityResponse.ok) {
                try {
                    reliability = await reliabilityResponse.json();
                } catch (e) {
                    reliability = null;
                }
            }

            const container = document.getElementById('predictions-container');

            if (!Array.isArray(data)) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-xl font-semibold text-gray-700">Errore nel caricamento previsioni Norvegia</h3>
                        <p class="text-gray-600">Riprova pi√π tardi o controlla la console</p>
                    </div>
                `;
                console.error('API Norway predictions returned non-array data:', data);
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚è∞</div>
                        <h3 class="text-xl font-semibold text-gray-700">Nessuna partita in programma in Eliteserien</h3>
                        <p class="text-gray-600">Torna pi√π tardi per le previsioni della prossima giornata</p>
                    </div>
                `;
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const sortedByProb = data.map(match => {
                const p = match.prediction;
                const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                return { match_id: match.match_id, maxProb };
            }).sort((a, b) => b.maxProb - a.maxProb);

            const highlightedIds = new Set();
            const maxTopPicks = 3;
            const minProbForTopPick = 60;
            const minAccuracyForTopPick = 55;

            for (let i = 0; i < Math.min(maxTopPicks, sortedByProb.length); i++) {
                const item = sortedByProb[i];
                const passesProb = item.maxProb >= minProbForTopPick;
                const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                if (passesProb && passesAccuracy) {
                    highlightedIds.add(item.match_id);
                }
            }
            lastPredictionsNorway = data;
            lastReliabilityNorway = reliability;
            lastHighlightedIdsNorway = highlightedIds;

            renderPredictionsGrid(data, reliability, highlightedIds, 'Eliteserien');
        }

        async function loadPredictionsPremier() {
            const [predictionsResponse, reliabilityResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/detailed/matches/next/predictions/premier`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }),
                fetch(`${API_BASE_URL}/predictions/reliability/seriea?last_n_matchdays=18`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }).catch(() => null)
            ]);

            const data = await predictionsResponse.json();
            let reliability = null;
            if (reliabilityResponse && reliabilityResponse.ok) {
                try {
                    reliability = await reliabilityResponse.json();
                } catch (e) {
                    reliability = null;
                }
            }

            if (!Array.isArray(data) || data.length === 0) {
                renderPredictionsGrid([], reliability, new Set(), 'Premier League');
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const sortedByProb = data.map(match => {
                const p = match.prediction;
                const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                return { match_id: match.match_id, maxProb };
            }).sort((a, b) => b.maxProb - a.maxProb);

            const highlightedIds = new Set();
            const maxTopPicks = 3;
            const minProbForTopPick = 60;
            const minAccuracyForTopPick = 55;

            for (let i = 0; i < Math.min(maxTopPicks, sortedByProb.length); i++) {
                const item = sortedByProb[i];
                const passesProb = item.maxProb >= minProbForTopPick;
                const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                if (passesProb && passesAccuracy) {
                    highlightedIds.add(item.match_id);
                }
            }

            renderPredictionsGrid(data, reliability, highlightedIds, 'Premier League');
        }

        async function loadPredictionsBundesliga() {
            const [predictionsResponse, reliabilityResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/detailed/matches/next/predictions/bundesliga`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }),
                fetch(`${API_BASE_URL}/predictions/reliability/seriea?last_n_matchdays=18`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }).catch(() => null)
            ]);

            const data = await predictionsResponse.json();
            let reliability = null;
            if (reliabilityResponse && reliabilityResponse.ok) {
                try {
                    reliability = await reliabilityResponse.json();
                } catch (e) {
                    reliability = null;
                }
            }

            if (!Array.isArray(data) || data.length === 0) {
                renderPredictionsGrid([], reliability, new Set(), 'Bundesliga');
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const sortedByProb = data.map(match => {
                const p = match.prediction;
                const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                return { match_id: match.match_id, maxProb };
            }).sort((a, b) => b.maxProb - a.maxProb);

            const highlightedIds = new Set();
            const maxTopPicks = 3;
            const minProbForTopPick = 60;
            const minAccuracyForTopPick = 55;

            for (let i = 0; i < Math.min(maxTopPicks, sortedByProb.length); i++) {
                const item = sortedByProb[i];
                const passesProb = item.maxProb >= minProbForTopPick;
                const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                if (passesProb && passesAccuracy) {
                    highlightedIds.add(item.match_id);
                }
            }

            renderPredictionsGrid(data, reliability, highlightedIds, 'Bundesliga');
        }

        async function loadPredictionsLaLiga() {
            const [predictionsResponse, reliabilityResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/detailed/matches/next/predictions/laliga`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }),
                fetch(`${API_BASE_URL}/predictions/reliability/seriea?last_n_matchdays=18`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                }).catch(() => null)
            ]);

            const data = await predictionsResponse.json();
            let reliability = null;
            if (reliabilityResponse && reliabilityResponse.ok) {
                try {
                    reliability = await reliabilityResponse.json();
                } catch (e) {
                    reliability = null;
                }
            }

            if (!Array.isArray(data) || data.length === 0) {
                renderPredictionsGrid([], reliability, new Set(), 'La Liga');
                return;
            }

            let modelAccuracyPct = null;
            let reliabilityMatchdays = null;
            let matchesEvaluated = null;
            if (reliability && typeof reliability.accuracy === 'number') {
                modelAccuracyPct = Math.round(reliability.accuracy * 100);
                if (Array.isArray(reliability.matchdays)) {
                    reliabilityMatchdays = reliability.matchdays.length;
                }
                if (typeof reliability.matches_evaluated === 'number') {
                    matchesEvaluated = reliability.matches_evaluated;
                }
            }

            const sortedByProb = data.map(match => {
                const p = match.prediction;
                const maxProb = Math.max(p.home_win_prob, p.draw_prob, p.away_win_prob);
                return { match_id: match.match_id, maxProb };
            }).sort((a, b) => b.maxProb - a.maxProb);

            const highlightedIds = new Set();
            const maxTopPicks = 3;
            const minProbForTopPick = 60;
            const minAccuracyForTopPick = 55;

            for (let i = 0; i < Math.min(maxTopPicks, sortedByProb.length); i++) {
                const item = sortedByProb[i];
                const passesProb = item.maxProb >= minProbForTopPick;
                const passesAccuracy = modelAccuracyPct === null || modelAccuracyPct >= minAccuracyForTopPick;
                if (passesProb && passesAccuracy) {
                    highlightedIds.add(item.match_id);
                }
            }

            renderPredictionsGrid(data, reliability, highlightedIds, 'La Liga');
        }

        // Helper function for rhythm color
        function getRhythmColor(score) {
            if (score >= 80) return 'text-green-600';
            if (score >= 60) return 'text-blue-600';
            if (score >= 40) return 'text-yellow-600';
            return 'text-red-600';
        }

        // Load standings
        async function loadStandings() {
            const response = await fetch(`${API_BASE_URL}/detailed/stats/seriea`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('standings-container');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Pos</th>
                                <th class="px-4 py-2 text-left">Squadra</th>
                                <th class="px-4 py-2 text-center">P</th>
                                <th class="px-4 py-2 text-center">V</th>
                                <th class="px-4 py-2 text-center">GF</th>
                                <th class="px-4 py-2 text-center">GS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.standings.standings.map((team, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100">
                                    <td class="px-4 py-2 font-bold">${team.position}</td>
                                    <td class="px-4 py-2 font-medium">${team.team.name}</td>
                                    <td class="px-4 py-2 text-center">${team.points}</td>
                                    <td class="px-4 py-2 text-center">${team.won}</td>
                                    <td class="px-4 py-2 text-center">${team.goals_for}</td>
                                    <td class="px-4 py-2 text-center">${team.goals_against}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadStandingsNorway() {
            const response = await fetch(`${API_BASE_URL}/norway/standings`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();

            const container = document.getElementById('standings-container');
            if (!data || !Array.isArray(data.standings)) {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                        <div class="text-red-600 text-4xl mb-2">‚ö†Ô∏è</div>
                        <h3 class="text-red-800 font-semibold">Errore</h3>
                        <p class="text-red-600">Impossibile caricare la classifica norvegese</p>
                    </div>
                `;
                console.error('Unexpected Norway standings payload', data);
                return;
            }

            container.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Pos</th>
                                <th class="px-4 py-2 text-left">Squadra</th>
                                <th class="px-4 py-2 text-center">P</th>
                                <th class="px-4 py-2 text-center">V</th>
                                <th class="px-4 py-2 text-center">GF</th>
                                <th class="px-4 py-2 text-center">GS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.standings.map((team, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100">
                                    <td class="px-4 py-2 font-bold">${team.position}</td>
                                    <td class="px-4 py-2 font-medium">${team.team.name}</td>
                                    <td class="px-4 py-2 text-center">${team.points}</td>
                                    <td class="px-4 py-2 text-center">${team.won}</td>
                                    <td class="px-4 py-2 text-center">${team.goals_for}</td>
                                    <td class="px-4 py-2 text-center">${team.goals_against}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Load top scorers
        async function loadTopScorers() {
            const response = await fetch(`${API_BASE_URL}/detailed/stats/seriea`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('scorers-container');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Giocatore</th>
                                <th class="px-4 py-2 text-left">Nazionalit√†</th>
                                <th class="px-4 py-2 text-center">Goal</th>
                                <th class="px-4 py-2 text-center">Assist</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.top_scorers.map((scorer, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100">
                                    <td class="px-4 py-2 font-medium">${scorer.player.name}</td>
                                    <td class="px-4 py-2 text-gray-600">${scorer.player.nationality}</td>
                                    <td class="px-4 py-2 text-center font-bold">${scorer.goals}</td>
                                    <td class="px-4 py-2 text-center">${scorer.assists || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function loadTopScorersNorway() {
            const response = await fetch(`${API_BASE_URL}/detailed/stats/norway`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('scorers-container');
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Giocatore</th>
                                <th class="px-4 py-2 text-left">Nazionalit√†</th>
                                <th class="px-4 py-2 text-center">Goal</th>
                                <th class="px-4 py-2 text-center">Assist</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.top_scorers.map((scorer, index) => `
                                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-gray-100">
                                    <td class="px-4 py-2 font-medium">${scorer.player.name}</td>
                                    <td class="px-4 py-2 text-gray-600">${scorer.player.nationality}</td>
                                    <td class="px-4 py-2 text-center font-bold">${scorer.goals}</td>
                                    <td class="px-4 py-2 text-center">${scorer.assists || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Load cards stats
        async function loadCardsStats() {
            const response = await fetch(`${API_BASE_URL}/detailed/stats/seriea`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('cards-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-4">üü® Cartellini Gialli</h3>
                        ${data.card_stats.sort((a, b) => b.yellow_cards - a.yellow_cards).slice(0, 5).map(team => `
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium">${team.team_name}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">${team.yellow_cards}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-4">üü• Cartellini Rossi</h3>
                        ${data.card_stats.sort((a, b) => b.red_cards - a.red_cards).slice(0, 5).map(team => `
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium">${team.team_name}</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded font-bold">${team.red_cards}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function loadCardsStatsNorway() {
            const response = await fetch(`${API_BASE_URL}/detailed/stats/norway`, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const data = await response.json();
            
            const container = document.getElementById('cards-container');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-4">üü® Cartellini Gialli</h3>
                        ${data.card_stats.sort((a, b) => b.yellow_cards - a.yellow_cards).slice(0, 5).map(team => `
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium">${team.team_name}</span>
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">${team.yellow_cards}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-4">üü• Cartellini Rossi</h3>
                        ${data.card_stats.sort((a, b) => b.red_cards - a.red_cards).slice(0, 5).map(team => `
                            <div class="flex justify-between items-center py-2 border-b">
                                <span class="font-medium">${team.team_name}</span>
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded font-bold">${team.red_cards}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getSelectedFinishedMatchday() {
            const input = document.getElementById('finished-matchday');
            if (!input || !input.value) return null;
            const value = parseInt(input.value, 10);
            if (isNaN(value) || value <= 0) return null;
            return value;
        }

        async function loadFinishedMatches() {
            const matchday = getSelectedFinishedMatchday();
            let url = `${API_BASE_URL}/detailed/matches/finished`;
            if (matchday !== null) {
                url += `?matchday=${matchday}`;
            }

            const response = await fetch(url, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const matches = await response.json();
            
            const container = document.getElementById('finished-matches-container');
            if (!Array.isArray(matches) || matches.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center">
                        <div class="text-4xl mb-2">üò¥</div>
                        <h3 class="text-lg font-semibold text-gray-800">Nessuna partita conclusa trovata</h3>
                        <p class="text-gray-600 mt-1">Modifica la giornata o riprova pi√π tardi.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = matches.map(match => `
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">${match.home_team} ${match.score} ${match.away_team}</h3>
                        <span class="text-sm text-gray-500">Giornata ${match.matchday}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">‚öΩ Goal</h4>
                            ${
                                match.goals && match.goals.length > 0
                                    ? match.goals.map(goal => `
                                        <div class="text-sm text-gray-600">
                                            ${goal.player || 'Giocatore sconosciuto'} (${goal.minute}') - ${goal.team || ''}
                                        </div>
                                    `).join('')
                                    : `<div class="text-sm text-gray-500">Nessun goal registrato</div>`
                            }
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">üü® Cartellini</h4>
                            ${
                                match.cards && match.cards.length > 0
                                    ? match.cards.map(card => `
                                        <div class="text-sm text-gray-600">
                                            ${card.player || 'Giocatore sconosciuto'} (${card.minute}') - ${card.card === 'yellow' ? 'üü®' : 'üü•'}
                                        </div>
                                    `).join('')
                                    : `<div class="text-sm text-gray-500">Nessun cartellino registrato</div>`
                            }
                    </div>
                </div>
            </div>
            `).join('');
        }

        async function loadFinishedMatchesNorway() {
            const matchday = getSelectedFinishedMatchday();
            let url = `${API_BASE_URL}/detailed/matches/finished/norway`;
            if (matchday !== null) {
                url += `?matchday=${matchday}`;
            }

            const response = await fetch(url, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const matches = await response.json();
            
            const container = document.getElementById('finished-matches-container');
            if (!Array.isArray(matches) || matches.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center">
                        <div class="text-4xl mb-2">üò¥</div>
                        <h3 class="text-lg font-semibold text-gray-800">Nessuna partita conclusa trovata</h3>
                        <p class="text-gray-600 mt-1">Modifica la giornata o riprova pi√π tardi.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = matches.map(match => `
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">${match.home_team} ${match.score} ${match.away_team}</h3>
                        <span class="text-sm text-gray-500">Giornata ${match.matchday}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">‚öΩ Goal</h4>
                            ${
                                match.goals && match.goals.length > 0
                                    ? match.goals.map(goal => `
                                        <div class="text-sm text-gray-600">
                                            ${goal.player || 'Giocatore sconosciuto'} (${goal.minute}') - ${goal.team || ''}
                                        </div>
                                    `).join('')
                                    : `<div class="text-sm text-gray-500">Nessun goal registrato</div>`
                            }
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">üü® Cartellini</h4>
                            ${
                                match.cards && match.cards.length > 0
                                    ? match.cards.map(card => `
                                        <div class="text-sm text-gray-600">
                                            ${card.player || 'Giocatore sconosciuto'} (${card.minute}') - ${card.card === 'yellow' ? 'üü®' : 'üü•'}
                                        </div>
                                    `).join('')
                                    : `<div class="text-sm text-gray-500">Nessun cartellino registrato</div>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getSelectedAnalysisDate() {
            const input = document.getElementById('analysis-date');
            if (!input || !input.value) return null;
            return input.value;
        }

        async function loadDailyAnalysis() {
            const dateStr = getSelectedAnalysisDate();
            let url = `${API_BASE_URL}/detailed/analysis/daily`;
            if (dateStr) {
                url += `?analysis_date=${dateStr}`;
            }

            const response = await fetch(url, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const analysis = await response.json();
            
            const container = document.getElementById('analysis-container');
            if (!analysis || analysis.total_matches === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center">
                        <div class="text-4xl mb-2">üì≠</div>
                        <h3 class="text-lg font-semibold text-gray-800">Nessuna partita trovata per questa data</h3>
                        <p class="text-gray-600 mt-1">Seleziona un altro giorno o prova con oggi.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">üìä Statistiche Giornata</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Partite:</span>
                                <span class="font-bold">${analysis.total_matches}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal totali:</span>
                                <span class="font-bold">${analysis.total_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal casa:</span>
                                <span class="font-bold">${analysis.home_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal trasferta:</span>
                                <span class="font-bold">${analysis.away_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Media goal:</span>
                                <span class="font-bold">${analysis.average_goals_per_match}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cartellini:</span>
                                <span class="font-bold">${analysis.total_cards}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Media cartellini:</span>
                                <span class="font-bold">${analysis.average_cards_per_match}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">üèÜ Risultati</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Vittorie casa:</span>
                                <span class="font-bold">${analysis.home_wins}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Vittorie trasferta:</span>
                                <span class="font-bold">${analysis.away_wins}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pareggi:</span>
                                <span class="font-bold">${analysis.draws}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>% Casa / Trasferta / Pareggi:</span>
                                <span class="font-bold">
                                    ${analysis.home_win_percentage}% /
                                    ${analysis.away_win_percentage}% /
                                    ${analysis.draw_percentage}%
                                </span>
                            </div>
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex justify-between">
                                <span>Over 2.5 goal:</span>
                                <span class="font-bold">
                                    ${analysis.matches_over_25_goals} (${analysis.total_matches > 0 ? ((analysis.matches_over_25_goals / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal entrambe le squadre:</span>
                                <span class="font-bold">
                                    ${analysis.matches_both_teams_score} (${analysis.total_matches > 0 ? ((analysis.matches_both_teams_score / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Clean sheet:</span>
                                <span class="font-bold">
                                    ${analysis.clean_sheets} (${analysis.total_matches > 0 ? ((analysis.clean_sheets / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Partite con rosso:</span>
                                <span class="font-bold">
                                    ${analysis.matches_with_red_card} (${analysis.total_matches > 0 ? ((analysis.matches_with_red_card / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">‚≠ê Highlights</h3>
                        <div class="space-y-2">
                            <div>
                                <span class="text-sm text-gray-600">Partita pi√π produttiva:</span>
                                <div class="font-medium">${analysis.most_productive_match}</div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Partita pi√π disciplinata:</span>
                                <div class="font-medium">${analysis.most_disciplined_match}</div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Vittoria pi√π larga:</span>
                                <div class="font-medium">${analysis.biggest_win}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadDailyAnalysisNorway() {
            const dateStr = getSelectedAnalysisDate();
            let url = `${API_BASE_URL}/detailed/analysis/norway/daily`;
            if (dateStr) {
                url += `?analysis_date=${dateStr}`;
            }

            const response = await fetch(url, {
                headers: {
                    'X-API-Key': API_KEY
                }
            });
            const analysis = await response.json();
            
            const container = document.getElementById('analysis-container');
            if (!analysis || analysis.total_matches === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-6 text-center">
                        <div class="text-4xl mb-2">üì≠</div>
                        <h3 class="text-lg font-semibold text-gray-800">Nessuna partita trovata per questa data</h3>
                        <p class="text-gray-600 mt-1">Seleziona un altro giorno o prova con oggi.</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">üìä Statistiche Giornata</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Partite:</span>
                                <span class="font-bold">${analysis.total_matches}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal totali:</span>
                                <span class="font-bold">${analysis.total_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal casa:</span>
                                <span class="font-bold">${analysis.home_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal trasferta:</span>
                                <span class="font-bold">${analysis.away_goals}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Media goal:</span>
                                <span class="font-bold">${analysis.average_goals_per_match}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cartellini:</span>
                                <span class="font-bold">${analysis.total_cards}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Media cartellini:</span>
                                <span class="font-bold">${analysis.average_cards_per_match}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">üèÜ Risultati</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Vittorie casa:</span>
                                <span class="font-bold">${analysis.home_wins}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Vittorie trasferta:</span>
                                <span class="font-bold">${analysis.away_wins}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Pareggi:</span>
                                <span class="font-bold">${analysis.draws}</span>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>% Casa / Trasferta / Pareggi:</span>
                                <span class="font-bold">
                                    ${analysis.home_win_percentage}% /
                                    ${analysis.away_win_percentage}% /
                                    ${analysis.draw_percentage}%
                                </span>
                            </div>
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex justify-between">
                                <span>Over 2.5 goal:</span>
                                <span class="font-bold">
                                    ${analysis.matches_over_25_goals} (${analysis.total_matches > 0 ? ((analysis.matches_over_25_goals / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Goal entrambe le squadre:</span>
                                <span class="font-bold">
                                    ${analysis.matches_both_teams_score} (${analysis.total_matches > 0 ? ((analysis.matches_both_teams_score / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Clean sheet:</span>
                                <span class="font-bold">
                                    ${analysis.clean_sheets} (${analysis.total_matches > 0 ? ((analysis.clean_sheets / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Partite con rosso:</span>
                                <span class="font-bold">
                                    ${analysis.matches_with_red_card} (${analysis.total_matches > 0 ? ((analysis.matches_with_red_card / analysis.total_matches) * 100).toFixed(1) : 0}%)
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-semibold text-gray-700 mb-2">‚≠ê Highlights</h3>
                        <div class="space-y-2">
                            <div>
                                <span class="text-sm text-gray-600">Partita pi√π produttiva:</span>
                                <div class="font-medium">${analysis.most_productive_match}</div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Partita pi√π disciplinata:</span>
                                <div class="font-medium">${analysis.most_disciplined_match}</div>
                            </div>
                            <div>
                                <span class="text-sm text-gray-600">Vittoria pi√π larga:</span>
                                <div class="font-medium">${analysis.biggest_win}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show error message
        function showError(sectionId, message) {
            const container = document.getElementById(`${sectionId}-container`);
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-red-600 text-4xl mb-2">‚ö†Ô∏è</div>
                    <h3 class="text-red-800 font-semibold">Errore</h3>
                    <p class="text-red-600">${message}</p>
                    <button onclick="loadSectionData('${sectionId}')" class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                        Riprova
                    </button>
                </div>
            `;
        }

        // Auto-refresh data every 5 minuti
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadSectionData(currentSection);
                updateLastUpdated();
            }, 300000); // 5 minuti
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                now.toLocaleTimeString('it-IT');
        }

        // Initialize the application
        async function initApp() {
            // Show loading state
            showSection('live-matches');
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Initial data load
            await loadSectionData('live-matches');
            await loadHistory2025Stats();
            updateLastUpdated();

            const topToggle = document.getElementById('only-top-picks-toggle');
            if (topToggle) {
                topToggle.addEventListener('change', async () => {
                    if (currentSection !== 'predictions') {
                        return;
                    }
                    if (currentLeague === 'seriea') {
                        if (lastPredictionsSerieA && lastHighlightedIdsSerieA) {
                            renderPredictionsGrid(lastPredictionsSerieA, lastReliabilitySerieA, lastHighlightedIdsSerieA, 'Serie A');
                        } else {
                            await loadPredictions();
                        }
                    } else {
                        if (lastPredictionsNorway && lastHighlightedIdsNorway) {
                            renderPredictionsGrid(lastPredictionsNorway, lastReliabilityNorway, lastHighlightedIdsNorway, 'Eliteserien');
                        } else {
                            await loadPredictionsNorway();
                        }
                    }
                });
            }
            
            // Set up periodic updates
            setInterval(updateLastUpdated, 60000); // Update time every minute
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
